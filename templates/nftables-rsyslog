# Make sure to have a timestamp in the log messages
template(name="CustomLogFormat" type="string"
         string="%timestamp:::date-rfc3339% %msg%\n")

# Logging nftables dropped packets to a file
module(load="omprog")

# If the message contains [nftables-drop] with 'IN=docker0', ignore it
# if $msg contains '[nftables-drop] IPv4 inbound denied: IN=docker0' then {
#     stop
# }

# If the message contains [nftables-drop]
if $msg contains '[nftables-drop]' then {
    # Send log to admin API through a python script
    action(type="omprog"
           name="nftables-dropped-log-to-database"
           binary="/opt/ezfirewall/bin/rsyslog-to-database.py"
           queue.type="LinkedList"
           queue.workerThreads="1"
           action.resumeInterval="5"
           killUnresponsive="on"
           template="CustomLogFormat")

    # Also log message to a file
    action (type="omfile" File="/var/log/nftables.log")

    stop
}
